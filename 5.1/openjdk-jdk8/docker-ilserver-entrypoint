#!/bin/bash
set -e

# Set defaults
ILSERVER_LOGLEVEL="${ILSERVER_LOGLEVEL:=INFO}"
ILSERVER_THREADS="${ILSERVER_NUMTHREADS:=1}"
ILSERVER_RAMBUFFER_SIZE="${ILSERVER_NUMTHREADS:=256}"
ILSERVER_MAX_FILESIZE="${ILSERVER_MAX_FILESIZE:=500}"

ILSERVER_CLIENT_NAME="${ILSERVER_CLIENT_NAME:=default}"
ILSERVER_NIC_ID="${ILSERVER_NIC_ID:=0}"
ILSERVER_ILIAS_INI_PATH="${ILSERVER_ILIAS_INI_PATH:=$PWD/ilias.ini.php}"

# Define templates
ILIAS_INI="
[server]
absolute_path = $PWD

[clients]
inifile = client.ini.php
path = $ILSERVER_DATA_PATH
datadir = $ILSERVER_ILIASDATA_PATH
"
ILSERVER_PROPERTIES="
[Server]
IpAddress = 0.0.0.0
Port = 11111
IndexPath = $ILSERVER_INDEX_PATH
LogFile = /dev/stdout
LogLevel = $ILSERVER_LOGLEVEL
NumThreads = $ILSERVER_NUMTHREADS
RamBufferSize = $ILSERVER_RAMBUFFER_SIZE
IndexMaxFileSizeMB = $ILSERVER_MAX_FILESIZE

[Client1]
ClientId = $ILSERVER_CLIENT_NAME
NicId = $ILSERVER_NIC_ID
IliasIniPath = $ILSERVER_ILIAS_INI_PATH
"

# Write config files
echo "${ILIAS_INI}" > $ILSERVER_ILIAS_INI_PATH
echo "${ILSERVER_PROPERTIES}" > $ILSERVER_PROPERTIES_PATH

exec "$@"
